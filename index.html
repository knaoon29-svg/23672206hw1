<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ê°€ìœ„ë°”ìœ„ë³´ AI ê²Œì„ (ì ìˆ˜ ëˆ„ì )</title>

  <!-- (ì„ íƒ) ê·€ì—¬ìš´ í°íŠ¸ -->
  <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      font-family:'Gaegu', cursive;
      background: linear-gradient(#dff1ff, #fefefe);
    }
    .wrap{
      width: 420px; max-width: calc(100vw - 24px);
      background:#fffaf0; border:5px solid #f3e6c8; border-radius:30px;
      padding:22px 22px 18px; box-shadow:0 15px 30px rgba(0,0,0,0.15);
      text-align:center;
    }
    h1{ margin:0 0 6px; color:#5b4636; font-size:28px; }
    .sub{ color:#8a7563; font-size:15px; margin-bottom:14px; line-height:1.2; }
    .row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin: 10px 0 14px; }
    button{
      background:#a8d5ba; border:none; border-radius:18px; padding:10px 16px;
      font-size:18px; cursor:pointer; color:#355f4e;
      box-shadow:0 6px 0 #7fb69a; transition: transform .15s, box-shadow .15s;
    }
    button:hover{ transform: translateY(2px); box-shadow:0 4px 0 #7fb69a; }
    button.secondary{ background:#f3e6c8; color:#5b4636; box-shadow:0 6px 0 #d8c9a4; }
    button.secondary:hover{ box-shadow:0 4px 0 #d8c9a4; }
    button.danger{ background:#ffd6d6; color:#7a2b2b; box-shadow:0 6px 0 #e8a8a8; }
    button.danger:hover{ box-shadow:0 4px 0 #e8a8a8; }

    .panel{
      background:#f0f7f3; border:3px dashed #c6e3d5; border-radius:22px;
      padding:10px; margin-bottom:10px;
    }
    canvas{ border-radius:16px; }
    .score{
      display:flex; justify-content:space-between; gap:10px;
      background:#fff; border-radius:18px; padding:10px 12px; margin:10px 0;
      box-shadow:0 3px 6px rgba(0,0,0,0.08);
      color:#5b4636; font-size:18px;
    }
    .score b{ font-size:20px; }
    .status{
      background:#fff; border-radius:18px; padding:10px 12px; margin:10px 0 0;
      box-shadow:0 3px 6px rgba(0,0,0,0.08);
      color:#5b4636; font-size:18px; line-height:1.25;
      white-space:pre-line;
    }
    .tiny{ font-size:13px; color:#8a7563; margin-top:10px; line-height:1.2; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>ğŸŒ± ì‘ì€ AI ê°€ìœ„ë°”ìœ„ë³´</h1>
    <div class="sub">3,2,1 ì¹´ìš´íŠ¸ í›„ í•œ ë²ˆë§Œ íŒì •í•˜ê³ <br>ìë™ìœ¼ë¡œ ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ì‹œì‘í•´ìš”</div>

    <div class="row">
      <button id="btnStart" type="button">ğŸ® ì‹œì‘</button>
      <button id="btnStop" type="button" class="secondary">â¸ï¸ ì¼ì‹œì •ì§€</button>
      <button id="btnReset" type="button" class="danger">ğŸ”„ ì ìˆ˜ ì´ˆê¸°í™”</button>
    </div>

    <div class="panel" id="webcam-container"></div>

    <div class="score">
      <div>ğŸ™‹ ì‚¬ìš©ì: <b id="uScore">0</b></div>
      <div>ğŸ¤ ë¬´ìŠ¹ë¶€: <b id="dScore">0</b></div>
      <div>ğŸ’» ì»´í“¨í„°: <b id="cScore">0</b></div>
    </div>

    <div class="status" id="status">ëŒ€ê¸° ì¤‘â€¦ (ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”)</div>

    <div class="tiny">
      âœ… ëª¨ë¸ í´ë˜ìŠ¤ëŠ” ë°˜ë“œì‹œ â€œê°€ìœ„ / ë°”ìœ„ / ë³´â€ì—¬ì•¼ í•©ë‹ˆë‹¤.<br>
      (ë‹¤ë¥´ë©´ ì•„ë˜ CHOICES ê°’ì„ ëª¨ë¸ í´ë˜ìŠ¤ëª…ê³¼ ë™ì¼í•˜ê²Œ ë°”ê¾¸ì„¸ìš”)
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

  <script>
    // âœ… Teachable Machine ëª¨ë¸ URL (ì‚¬ìš©ì ì œê³µ)
    const URL = "https://teachablemachine.withgoogle.com/models/kMHQfboVr/";

    // âœ… ëª¨ë¸ í´ë˜ìŠ¤ëª… (Teachable Machineì˜ classNameê³¼ 'ì™„ì „íˆ ë™ì¼'í•´ì•¼ í•¨)
    const CHOICES = ["ê°€ìœ„", "ë°”ìœ„", "ë³´"];

    // ê²Œì„ ì„¤ì •
    const COUNTDOWN_SECONDS = 3;       // 3,2,1
    const BETWEEN_ROUND_MS = 2500;     // ê²°ê³¼ í‘œì‹œ í›„ ë‹¤ìŒ ë¼ìš´ë“œê¹Œì§€ ëŒ€ê¸°
    const MIN_CONFIDENCE = 0.60;       // ì¸ì‹ ì‹ ë¢°ë„(0~1). ë‚®ìœ¼ë©´ "ë‹¤ì‹œ í•´ë´ìš”" ì²˜ë¦¬

    let model, webcam, maxPredictions;

    // ìƒíƒœ
    let initialized = false;
    let running = false;              // ì „ì²´ ê²Œì„ ì§„í–‰ ì—¬ë¶€
    let phase = "idle";               // idle | countdown | capture | result
    let countdown = COUNTDOWN_SECONDS;
    let computerChoice = "";
    let countdownTimer = null;
    let nextRoundTimer = null;

    // ì ìˆ˜
    let userScore = 0;
    let compScore = 0;
    let drawScore = 0;

    const $webcam = document.getElementById("webcam-container");
    const $status = document.getElementById("status");
    const $uScore = document.getElementById("uScore");
    const $cScore = document.getElementById("cScore");
    const $dScore = document.getElementById("dScore");

    document.getElementById("btnStart").addEventListener("click", async () => {
      if (!initialized) {
        await init();
      }
      startGame();
    });

    document.getElementById("btnStop").addEventListener("click", () => {
      stopGame("ì¼ì‹œì •ì§€ë¨. ë‹¤ì‹œ ì‹œì‘ì„ ëˆ„ë¥´ë©´ ì´ì–´ì§‘ë‹ˆë‹¤.");
    });

    document.getElementById("btnReset").addEventListener("click", () => {
      userScore = 0; compScore = 0; drawScore = 0;
      renderScores();
      stopGame("ì ìˆ˜ë¥¼ ì´ˆê¸°í™”í–ˆì–´ìš”. ì‹œì‘ì„ ëˆ„ë¥´ë©´ ìƒˆë¡œ ì§„í–‰í•©ë‹ˆë‹¤.");
    });

    function renderScores(){
      $uScore.textContent = String(userScore);
      $cScore.textContent = String(compScore);
      $dScore.textContent = String(drawScore);
    }

    function setStatus(text){
      $status.textContent = text;
    }

    function clearTimers(){
      if (countdownTimer) { clearInterval(countdownTimer); countdownTimer = null; }
      if (nextRoundTimer) { clearTimeout(nextRoundTimer); nextRoundTimer = null; }
    }

    function stopGame(message){
      running = false;
      phase = "idle";
      clearTimers();
      if (message) setStatus(message);
    }

    function getComputerChoice(){
      return CHOICES[Math.floor(Math.random() * CHOICES.length)];
    }

    function judge(user, computer){
      if (user === computer) return "DRAW";
      if (
        (user === "ê°€ìœ„" && computer === "ë³´") ||
        (user === "ë°”ìœ„" && computer === "ê°€ìœ„") ||
        (user === "ë³´" && computer === "ë°”ìœ„")
      ) return "WIN";
      return "LOSE";
    }

    async function init(){
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();

      const flip = true;
      webcam = new tmImage.Webcam(240, 240, flip);
      await webcam.setup();
      await webcam.play();
      window.requestAnimationFrame(loop);

      // webcam ìº”ë²„ìŠ¤ ë¶™ì´ê¸° (ì¤‘ë³µ ë°©ì§€)
      $webcam.innerHTML = "";
      $webcam.appendChild(webcam.canvas);

      initialized = true;
      setStatus("ì¤€ë¹„ ì™„ë£Œ! ì‹œì‘ì„ ëˆ„ë¥´ë©´ ê²Œì„ì´ ì§„í–‰ë©ë‹ˆë‹¤.");
    }

    function startGame(){
      if (!initialized) return;
      running = true;
      clearTimers();
      startRound();
    }

    function startRound(){
      if (!running) return;

      phase = "countdown";
      countdown = COUNTDOWN_SECONDS;
      computerChoice = getComputerChoice();

      setStatus(`â³ ${countdown}\n(ì¹´ë©”ë¼ ì•ì—ì„œ ê°€ìœ„/ë°”ìœ„/ë³´ë¥¼ ì¤€ë¹„!)`);

      countdownTimer = setInterval(() => {
        if (!running) return;

        countdown -= 1;
        if (countdown > 0) {
          setStatus(`â³ ${countdown}\n(ì¹´ë©”ë¼ ì•ì—ì„œ ê°€ìœ„/ë°”ìœ„/ë³´ë¥¼ ì¤€ë¹„!)`);
        } else {
          clearInterval(countdownTimer);
          countdownTimer = null;

          phase = "capture";
          setStatus("ğŸ“¸ ì§€ê¸ˆ! íŒì •í•©ë‹ˆë‹¤â€¦");
          // predict()ê°€ ë‹¤ìŒ í”„ë ˆì„ì—ì„œ 1íšŒ íŒì •í•˜ë„ë¡ phaseë¥¼ captureë¡œ ë‘ 
        }
      }, 1000);
    }

    async function loop(){
      if (webcam) webcam.update();
      await maybePredictOnce();
      window.requestAnimationFrame(loop);
    }

    async function maybePredictOnce(){
      if (!running) return;
      if (!model || !webcam) return;

      // capture ë‹¨ê³„ì—ì„œë§Œ 1íšŒ íŒì •
      if (phase !== "capture") return;

      const prediction = await model.predict(webcam.canvas);

      // ê°€ì¥ ë†’ì€ í™•ë¥ ì˜ í´ë˜ìŠ¤ ì°¾ê¸°
      let best = prediction[0];
      for (let i = 1; i < prediction.length; i++){
        if (prediction[i].probability > best.probability) best = prediction[i];
      }

      const userChoice = best.className;
      const conf = best.probability;

      // ì‹ ë¢°ë„ ë‚®ìœ¼ë©´ ë¬´íš¨ ì²˜ë¦¬ (ìë™ ì¬ì‹œì‘)
      if (conf < MIN_CONFIDENCE){
        phase = "result";
        setStatus(
          `ğŸ˜³ ì˜ ì•ˆ ë³´ì˜€ì–´ìš”!\n` +
          `ì¸ì‹: ${userChoice} (${Math.round(conf*100)}%)\n` +
          `ì¡°ê¸ˆ ë” í¬ê²Œ ë³´ì—¬ì£¼ê³  ë‹¤ì‹œ í•´ë³¼ê¹Œìš”?`
        );

        nextRoundTimer = setTimeout(() => {
          if (running) startRound();
        }, BETWEEN_ROUND_MS);

        return;
      }

      const result = judge(userChoice, computerChoice);

      if (result === "WIN") userScore += 1;
      else if (result === "LOSE") compScore += 1;
      else drawScore += 1;

      renderScores();

      phase = "result";
      setStatus(
        `ğŸ™‹ ì‚¬ìš©ì: ${userChoice} (${Math.round(conf*100)}%)\n` +
        `ğŸ’» ì»´í“¨í„°: ${computerChoice}\n` +
        `ğŸ ê²°ê³¼: ${result}\n` +
        `(${BETWEEN_ROUND_MS/1000}ì´ˆ ë’¤ ë‹¤ìŒ ë¼ìš´ë“œ!)`
      );

      nextRoundTimer = setTimeout(() => {
        if (running) startRound();
      }, BETWEEN_ROUND_MS);
    }
  </script>
</body>
</html>
